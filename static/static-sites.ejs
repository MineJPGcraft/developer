<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>
    <%= ui.siteTitle %>ï½œé™æ€æ‰˜ç®¡
  </title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/yumeri-ui@latest/dist/yumeri-ui.css" />
  <style>
    /* --- åŸºç¡€å¸ƒå±€é‡ç½® --- */
    body {
      background: #fff;
      color: #1f2933;
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    /* å¼ºåˆ¶ app-shell ä¸å…è®¸æº¢å‡ºå±å¹•å®½åº¦ */
    .app-shell {
      width: 100%;
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #111827;
      color: #f9fafb;
    }

    header .brand {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 2rem;
      flex-wrap: wrap;
    }

    nav ul {
      list-style: none;
      display: flex;
      gap: 1.25rem;
      margin: 0;
      padding: 0;
      flex-wrap: wrap;
    }

    nav a {
      color: #e2e8f0;
      text-decoration: none;
      font-size: .95rem;
      font-weight: 500;
    }

    nav a:hover {
      text-decoration: underline;
    }

    main {
      padding: 1.5rem 1rem;
    }

    /* å®¹å™¨å“åº”å¼å®½åº¦æ§åˆ¶ */
    .container {
      max-width: 1100px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
    }

    .section-title {
      font-size: 1.4rem;
      margin-bottom: .5rem;
      font-weight: 600;
    }

    .muted {
      color: #64748b;
      font-size: .95rem;
    }

    /* --- Card æ ¸å¿ƒä¿®å¤ï¼šé˜²æ­¢æ’‘ç ´ --- */
    .card {
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      background: #fff;
      min-width: 0;
      /* å…³é”®ï¼šå…è®¸å­å…ƒç´ åœ¨ Flex/Grid ä¸­æ”¶ç¼© */
      overflow: hidden;
      /* å…³é”®ï¼šç¦æ­¢å†…éƒ¨å†…å®¹æº¢å‡º Card è¾¹ç•Œ */
    }

    /* å“åº”å¼ç½‘æ ¼ */
    .grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 1.5rem;
    }

    /* --- æ–‡ä»¶è¡¨æ ¼æ»šåŠ¨å®¹å™¨ --- */
    .file-table-container {
      margin-top: 1rem;
      width: 100%;
      /* å¡«æ»¡çˆ¶çº§ Card */
      overflow-x: auto;
      /* å¼€å¯å†…éƒ¨æ¨ªå‘æ»šåŠ¨ */
      -webkit-overflow-scrolling: touch;
      border: 1px solid #f1f5f9;
      border-radius: 8px;
    }

    .file-table {
      width: 100%;
      min-width: 600px;
      /* ä¿è¯å†…éƒ¨æœ‰æ»šåŠ¨ç©ºé—´ */
      border-collapse: collapse;
      table-layout: fixed;
      /* é”å®šåˆ—å®½ï¼Œä¸è¢«å†…å®¹å¼ºè¡Œæ’‘å¤§ */
    }

    .file-table th,
    .file-table td {
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
      padding: .75rem .5rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      /* é•¿æ–‡ä»¶åæ˜¾ç¤ºçœç•¥å· */
    }

    /* å®šä¹‰å„åˆ—æ¯”ä¾‹ */
    .file-table th:nth-child(1) {
      width: 40px;
    }

    /* Checkbox */
    .file-table th:nth-child(2) {
      width: 40%;
    }

    /* åç§° */
    .file-table th:nth-child(3) {
      width: 15%;
    }

    /* ç±»å‹ */
    .file-table th:nth-child(4) {
      width: 20%;
    }

    /* å¤§å° */
    .file-table th:nth-child(5) {
      width: 20%;
    }

    /* æ›´æ–°æ—¶é—´ */

    .file-table tr.selected {
      background: #eff6ff;
    }

    .file-table tr:hover {
      background: #f8fafc;
      cursor: pointer;
    }

    /* --- å…¶ä»–ç»„ä»¶ --- */
    .space-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .space-item {
      padding: .6rem .8rem;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: .6rem;
      cursor: pointer;
    }

    .space-item.active {
      border-color: #2563eb;
      background: #eff6ff;
    }

    .actions {
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 1rem;
    }

    .dropzone {
      border: 2px dashed #cbd5f5;
      border-radius: 12px;
      padding: 1.2rem;
      text-align: center;
      background: #f8fafc;
    }

    .dropzone.dragover {
      border-color: #2563eb;
      background: #eff6ff;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: .4rem;
      background: #e2e8f0;
      padding: .25rem .6rem;
      border-radius: 999px;
      font-size: 0.85rem;
    }

    .path {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: .85rem;
    }

    /* --- è¿›åº¦æ¡æç¤ºæ¡† (Task Toast) --- */
    #task-toast {
      position: fixed;
      bottom: 2rem;
      right: 1.5rem;
      width: min(320px, 90vw);
      /* æ‰‹æœºä¸Šè‡ªåŠ¨ç¼©å°å®½åº¦ */
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      padding: 1.2rem;
      z-index: 2000;
      display: none;
    }

    .progress-bar {
      height: 8px;
      background: #e2e8f0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 10px;
    }

    .progress-inner {
      height: 100%;
      background: #2563eb;
      width: 0%;
      transition: width 0.3s;
    }

    /* --- å“åº”å¼æ–­ç‚¹ --- */
    @media(max-width:960px) {
      .grid {
        grid-template-columns: 1fr;
      }

      main {
        padding: 1rem 0.5rem;
      }
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <header>
      <div class="container" style="padding:1rem 0;">
        <div class="header-bar">
          <span class="brand">
            <%= ui.siteTitle %>
          </span>
          <nav>
            <ul>
              <% if (ui && ui.navigation) { %>
                <% ui.navigation.forEach(function(item){ %>
                  <li><a href="<%= item.href %>">
                      <%= item.label %>
                    </a></li>
                  <% }); %>
                    <% } %>
            </ul>
          </nav>
        </div>
      </div>
    </header>
    <main>
      <div class="container">
        <h2 class="section-title">é™æ€æ‰˜ç®¡</h2>
        <p class="muted">æ¯ä¸ªç©ºé—´å¯ç»‘å®šå¤šä¸ªåŸŸåï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰ã€‚CNAME æŒ‡å‘ï¼š<strong>
            <%= cnameTarget || 'ï¼ˆæœªé…ç½®ï¼‰' %>
          </strong></p>

        <div class="grid">
          <div class="card">
            <h3 class="section-title" style="font-size:1.1rem;">æˆ‘çš„ç©ºé—´</h3>
            <ul class="space-list" id="space-list"></ul>
            <form id="space-create-form" class="yui-form" novalidate>
              <div class="yui-form__group">
                <label for="space-name">æ–°ç©ºé—´åç§°</label>
                <input class="input" id="space-name" name="name" required />
              </div>
              <button type="submit" class="btn btn-primary" style="width:100%">åˆ›å»ºç©ºé—´</button>
            </form>
            <p class="muted" id="space-error" style="color:#ef4444;display:none;"></p>
          </div>

          <div class="card">
            <h3 class="section-title" style="font-size:1.1rem;">æ–‡ä»¶ç®¡ç†</h3>
            <div class="actions" style="margin-bottom:.5rem;">
              <button class="btn btn-secondary btn-sm" id="btn-new-folder" type="button">æ–°å»ºç›®å½•</button>
              <button class="btn btn-secondary btn-sm" id="btn-new-file" type="button">æ–°å»ºæ–‡ä»¶</button>
              <button class="btn btn-secondary btn-sm" id="btn-edit-file" type="button">ç¼–è¾‘</button>
              <button class="btn btn-secondary btn-sm" id="btn-rename" type="button">é‡å‘½å</button>
              <button class="btn btn-secondary btn-sm" id="btn-delete" type="button">åˆ é™¤</button>
              <button class="btn btn-primary btn-sm" id="btn-zip" type="button">Zipå‹ç¼©</button>
              <button class="btn btn-primary btn-sm" id="btn-unzip" type="button">è§£å‹åˆ°...</button>
              <button class="btn btn-secondary btn-sm" id="btn-refresh" type="button">åˆ·æ–°</button>
              <span class="chip">å½“å‰ï¼š<span class="path" id="current-path">/</span></span>
            </div>
            <div class="dropzone" id="dropzone">
              æ‹–æ‹½ä¸Šä¼ ï¼Œæˆ– <label style="color:#2563eb; cursor:pointer;">é€‰æ‹©æ–‡ä»¶<input type="file" id="file-input"
                  style="display:none;" multiple /></label>
            </div>
            <div style="margin-top:1rem; overflow-x: auto;">
              <table class="file-table">
                <thead>
                  <tr>
                    <th style="width:30px;"><input type="checkbox" id="select-all"></th>
                    <th>åç§°</th>
                    <th>ç±»å‹</th>
                    <th>å¤§å°</th>
                    <th>æ›´æ–°æ—¶é—´</th>
                  </tr>
                </thead>
                <tbody id="file-table"></tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 class="section-title" style="font-size:1.1rem;">åŸŸåç»‘å®š</h3>
          <div class="muted" id="domain-list" style="margin-bottom: 1rem;"></div>
          <form id="domain-form" class="yui-form" novalidate>
            <div class="yui-form__group">
              <label for="domain-input">ç»‘å®šåŸŸåï¼ˆæ”¯æŒ *.example.comï¼‰</label>
              <input class="input" id="domain-input" name="domain" placeholder="ä¾‹å¦‚ï¼šstatic.example.com" required />
            </div>
            <div class="actions">
              <button type="submit" class="btn btn-primary">ç»‘å®šåŸŸå</button>
              <button type="button" class="btn btn-secondary" id="domain-remove">è§£ç»‘åŸŸå</button>
            </div>
          </form>
          <p class="muted" id="domain-error" style="color:#ef4444;display:none;"></p>
        </div>
      </div>
    </main>
  </div>

  <div id="task-toast">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <strong id="task-title" style="font-size: 0.95rem;">å¤„ç†ä¸­...</strong>
      <span id="task-percent" style="font-weight: bold; color: #2563eb;">0%</span>
    </div>
    <div class="progress-bar">
      <div class="progress-inner" id="task-progress"></div>
    </div>
    <p class="muted" id="task-status" style="margin-top:8px; font-size:12px;"></p>
  </div>

  <div id="editor-modal" style="display:none; position:fixed; inset:0; background:rgba(15,23,42,.55); z-index:1200;">
    <div
      style="background:#fff; margin:4vh auto; width:min(1100px,94%); height:92vh; border-radius:12px; display:flex; flex-direction:column;">
      <div
        style="padding:1rem 1.2rem; border-bottom:1px solid #e2e8f0; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <strong>åœ¨çº¿ç¼–è¾‘å™¨</strong>
          <span class="muted" id="editor-path" style="margin-left:.6rem;"></span>
        </div>
        <div class="actions">
          <button class="btn btn-primary btn-sm" id="editor-save">ä¿å­˜</button>
          <button class="btn btn-secondary btn-sm" id="editor-close">å…³é—­</button>
        </div>
      </div>
      <div id="editor-container" style="flex:1 1 auto;"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
  <script>
    const state = {
      spaces: [],
      currentSpace: null,
      currentPath: '',
      selectedItems: new Set() // å­˜å‚¨å¤šé€‰çš„æ–‡ä»¶å
    };

    function showError(id, msg) {
      const el = document.getElementById(id);
      if (!el) return;
      if (msg) { el.style.display = 'block'; el.textContent = msg; }
      else { el.style.display = 'none'; el.textContent = ''; }
    }

    async function api(url, options) {
      const res = await fetch(url, options);
      const data = await res.json();
      if (!data.success) throw new Error(data.message || 'è¯·æ±‚å¤±è´¥');
      return data.data;
    }

    // --- ä»»åŠ¡è¿›åº¦ç›‘å¬é€»è¾‘ ---
    async function trackTask(taskId, title) {
      const toast = document.getElementById('task-toast');
      const progress = document.getElementById('task-progress');
      const percentText = document.getElementById('task-percent');
      const statusText = document.getElementById('task-status');

      toast.style.display = 'block';
      document.getElementById('task-title').textContent = title;

      const timer = setInterval(async () => {
        try {
          const task = await api(`/api/static/tasks/${taskId}`);
          const p = task.progress || 0;
          progress.style.width = p + '%';
          percentText.textContent = p + '%';
          statusText.textContent = task.message || 'å¤„ç†ä¸­...';

          // å…³é”®ä¿®æ”¹ï¼šå®Œæˆå 1.5 ç§’è‡ªåŠ¨éšè—
          if (task.status === 'completed' || p >= 100) {
            clearInterval(timer);
            statusText.textContent = 'å®Œæˆï¼åˆ—è¡¨å·²æ›´æ–°';
            await loadFiles(state.currentPath); // è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨
            setTimeout(() => {
              toast.style.display = 'none';
              progress.style.width = '0%'; // é‡ç½®è¿›åº¦æ¡
            }, 1500);
          } else if (task.status === 'failed') {
            clearInterval(timer);
            alert('é”™è¯¯: ' + task.error);
            toast.style.display = 'none';
          }
        } catch (e) {
          clearInterval(timer);
          toast.style.display = 'none';
        }
      }, 1000);
    }

    document.getElementById('btn-refresh').onclick = async () => {
      const btn = document.getElementById('btn-refresh');
      btn.disabled = true;
      btn.textContent = 'åˆ·æ–°ä¸­...';
      try {
        await loadFiles(state.currentPath);
        await loadSpaces();
      } finally {
        btn.disabled = false;
        btn.textContent = 'åˆ·æ–°';
      }
    };

    // --- ç©ºé—´ç®¡ç† ---
    async function loadSpaces() {
      state.spaces = await api('/api/static/spaces');
      if (!state.currentSpace && state.spaces.length) {
        state.currentSpace = state.spaces[0];
      }
      renderSpaces();
      if (state.currentSpace) {
        await loadFiles('');
        renderDomains();
      }
    }

    function renderSpaces() {
      const list = document.getElementById('space-list');
      list.innerHTML = '';
      state.spaces.forEach(space => {
        const li = document.createElement('li');
        li.className = 'space-item' + (state.currentSpace && state.currentSpace.id === space.id ? ' active' : '');
        li.textContent = `${space.name} (${(space.usedBytes / 1024 / 1024).toFixed(1)} MB)`;
        li.onclick = async () => {
          state.currentSpace = space;
          state.currentPath = '';
          renderSpaces();
          await loadFiles('');
          renderDomains();
        };
        list.appendChild(li);
      });
    }

    // --- æ–‡ä»¶ç®¡ç† ---
    async function loadFiles(path) {
      if (!state.currentSpace) return;
      state.currentPath = path || '';
      state.selectedItems.clear();
      document.getElementById('select-all').checked = false;
      document.getElementById('current-path').textContent = '/' + (state.currentPath || '');

      const data = await api(`/api/static/spaces/${encodeURIComponent(state.currentSpace.id)}/tree?path=${encodeURIComponent(state.currentPath)}`);
      const tbody = document.getElementById('file-table');
      tbody.innerHTML = '';

      if (state.currentPath) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td></td><td colspan="4">.. (è¿”å›ä¸Šçº§)</td>`;
        tr.onclick = () => {
          const parts = state.currentPath.split('/').filter(Boolean);
          parts.pop();
          loadFiles(parts.join('/'));
        };
        tbody.appendChild(tr);
      }

      data.forEach(item => {
        const tr = document.createElement('tr');
        tr.dataset.name = item.name;
        tr.dataset.type = item.type;
        tr.innerHTML = `
          <td><input type="checkbox" class="file-check" data-name="${item.name}"></td>
          <td>${item.type === 'dir' ? 'ğŸ“' : 'ğŸ“„'} ${item.name}</td>
          <td>${item.type}</td>
          <td>${item.type === 'file' ? (item.size / 1024).toFixed(1) + ' KB' : '-'}</td>
          <td>${item.updatedAt || '-'}</td>
        `;

        tr.onclick = (e) => {
          if (e.target.type === 'checkbox') return;
          // è¡Œç‚¹å‡»é€‰ä¸­åˆ‡æ¢
          const cb = tr.querySelector('.file-check');
          cb.checked = !cb.checked;
          updateSelection(item.name, cb.checked, tr);
        };

        tr.querySelector('.file-check').onclick = (e) => {
          updateSelection(item.name, e.target.checked, tr);
        };

        // åŒå‡»è¿›å…¥ç›®å½•
        tr.ondblclick = () => {
          if (item.type === 'dir') {
            loadFiles((state.currentPath ? state.currentPath + '/' : '') + item.name);
          }
        };

        tbody.appendChild(tr);
      });
    }

    function updateSelection(name, isChecked, row) {
      if (isChecked) {
        state.selectedItems.add(name);
        row.classList.add('selected');
      } else {
        state.selectedItems.delete(name);
        row.classList.remove('selected');
      }
    }

    function getSelectedItem() {
      const first = state.selectedItems.values().next().value;
      if (!first) return null;
      // å…¼å®¹æ—§é€»è¾‘ï¼Œè¿”å›ç¬¬ä¸€ä¸ªé€‰ä¸­çš„è¯¦æƒ…
      const row = document.querySelector(`.file-check[data-name="${first}"]`).closest('tr');
      return { name: first, type: row.dataset.type };
    }

    // --- åŸŸåç»‘å®šæ¸²æŸ“ ---
    async function renderDomains() {
      const box = document.getElementById('domain-list');
      if (!state.currentSpace) {
        box.textContent = 'è¯·å…ˆé€‰æ‹©ç©ºé—´';
        return;
      }
      const domains = state.currentSpace.domains || [];
      box.innerHTML = domains.length ? domains.map(d => `<span class="chip">${d}</span>`).join(' ') : 'æš‚æ— ç»‘å®šåŸŸå';
    }

    // --- æŒ‰é’®äº‹ä»¶ ---
    document.getElementById('select-all').onchange = (e) => {
      const checked = e.target.checked;
      document.querySelectorAll('.file-check').forEach(cb => {
        cb.checked = checked;
        const row = cb.closest('tr');
        updateSelection(cb.dataset.name, checked, row);
      });
    };

    document.getElementById('btn-zip').onclick = async () => {
      if (state.selectedItems.size === 0) return alert('è¯·é€‰æ‹©è¦å‹ç¼©çš„æ–‡ä»¶æˆ–ç›®å½•');
      const outputName = prompt('è¯·è¾“å…¥å‹ç¼©æ–‡ä»¶å', 'archive.zip');
      if (!outputName) return;
      const paths = Array.from(state.selectedItems).map(n => (state.currentPath ? state.currentPath + '/' : '') + n);
      try {
        const res = await api(`/api/static/spaces/${encodeURIComponent(state.currentSpace.id)}/zip`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paths, outputName })
        });
        trackTask(res.taskId, 'æ­£åœ¨ç”Ÿæˆå‹ç¼©åŒ…');
      } catch (err) { alert(err.message); }
    };

    document.getElementById('btn-unzip').onclick = async () => {
      const item = getSelectedItem();
      if (!item || !item.name.endsWith('.zip')) return alert('è¯·é€‰æ‹©ä¸€ä¸ª .zip æ–‡ä»¶è¿›è¡Œè§£å‹');
      const targetDir = prompt('è¯·è¾“å…¥è§£å‹ç›®æ ‡ç›®å½• (ç•™ç©ºä¸ºå½“å‰ç›®å½•)', state.currentPath);
      const zipPath = (state.currentPath ? state.currentPath + '/' : '') + item.name;
      try {
        const res = await api(`/api/static/spaces/${encodeURIComponent(state.currentSpace.id)}/unzip`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: zipPath, targetDir })
        });
        trackTask(res.taskId, 'æ­£åœ¨è§£å‹æ–‡ä»¶');
      } catch (err) { alert(err.message); }
    };

    // --- ä¸Šä¼ ã€åˆ é™¤ã€åŸŸåç­‰é€»è¾‘ ---
    async function uploadFile(file) {
      if (!state.currentSpace) return;
      const form = new FormData();
      form.append('file', file);
      await fetch(`/api/static/spaces/${encodeURIComponent(state.currentSpace.id)}/upload?path=${encodeURIComponent(state.currentPath)}`, { method: 'POST', body: form });
      await loadSpaces();
    }

    document.getElementById('btn-delete').onclick = async () => {
      if (state.selectedItems.size === 0) return alert('è¯·å…ˆå‹¾é€‰è¦åˆ é™¤çš„é¡¹');
      if (!confirm(`ç¡®å®šåˆ é™¤è¿™ ${state.selectedItems.size} é¡¹å—ï¼Ÿ`)) return;
      for (let name of state.selectedItems) {
        const target = (state.currentPath ? state.currentPath + '/' : '') + name;
        await api(`/api/static/spaces/${encodeURIComponent(state.currentSpace.id)}/item?path=${encodeURIComponent(target)}`, { method: 'DELETE' });
      }
      await loadFiles(state.currentPath);
      await loadSpaces();
    };

    // (çœç•¥é‡å¤çš„ editorInstance åˆå§‹åŒ–é€»è¾‘ï¼Œä¸ä½ åŸä»£ç ä¸€è‡´)
    let editorInstance = null;
    let editorReady = false;
    let editorPath = '';

    function getLanguageByPath(filePath) {
      const ext = (filePath.split('.').pop() || '').toLowerCase();
      const map = { 'html': 'html', 'css': 'css', 'js': 'javascript', 'json': 'json', 'md': 'markdown' };
      return map[ext] || 'plaintext';
    }

    function openEditor(path, content) {
      editorPath = path;
      document.getElementById('editor-path').textContent = path;
      document.getElementById('editor-modal').style.display = 'block';
      if (!editorReady) {
        require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } });
        require(['vs/editor/editor.main'], function () {
          editorReady = true;
          editorInstance = monaco.editor.create(document.getElementById('editor-container'), {
            value: content || '',
            language: getLanguageByPath(path),
            theme: 'vs',
            automaticLayout: true,
          });
        });
      } else {
        const model = monaco.editor.createModel(content || '', getLanguageByPath(path));
        editorInstance.setModel(model);
      }
    }

    document.getElementById('btn-edit-file').onclick = async () => {
      const item = getSelectedItem();
      if (!item || item.type !== 'file') return alert('è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œç¼–è¾‘');
      const target = (state.currentPath ? state.currentPath + '/' : '') + item.name;
      const data = await api(`/api/static/spaces/${encodeURIComponent(state.currentSpace.id)}/file?path=${encodeURIComponent(target)}`);
      openEditor(target, data.content);
    };

    document.getElementById('editor-save').onclick = async () => {
      const content = editorInstance.getValue();
      await api(`/api/static/spaces/${encodeURIComponent(state.currentSpace.id)}/file`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path: editorPath, content })
      });
      document.getElementById('editor-modal').style.display = 'none';
      await loadFiles(state.currentPath);
    };

    document.getElementById('editor-close').onclick = () => document.getElementById('editor-modal').style.display = 'none';

    // åŸŸåå¤„ç†é€»è¾‘å›å¤
    document.getElementById('domain-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      showError('domain-error', '');
      const domain = document.getElementById('domain-input').value;
      try {
        const updated = await api(`/api/static/spaces/${encodeURIComponent(state.currentSpace.id)}/domains`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ domain })
        });
        state.currentSpace.domains = updated;
        renderDomains();
      } catch (err) { showError('domain-error', err.message); }
    });

    document.getElementById('domain-remove').onclick = async () => {
      const domain = prompt('è¯·è¾“å…¥è¦è§£ç»‘çš„åŸŸå');
      if (!domain) return;
      const updated = await api(`/api/static/spaces/${encodeURIComponent(state.currentSpace.id)}/domains`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ domain })
      });
      state.currentSpace.domains = updated;
      renderDomains();
    };

    // åˆå§‹åŒ–åŠ è½½
    (async () => { await loadSpaces(); })();
  </script>
</body>

</html>